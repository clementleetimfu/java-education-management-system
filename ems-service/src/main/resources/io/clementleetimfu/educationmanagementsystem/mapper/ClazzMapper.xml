<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.clementleetimfu.educationmanagementsystem.mapper.ClazzMapper">

    <select id="searchClazz" resultMap="searchClazzResultMap">
        SELECT
        c.id,
        c.name AS clazzName,
        e.name AS teacherName,
        c.start_date,
        c.end_date,
        c.update_time
        FROM clazz c
        LEFT JOIN employee e
        ON c.teacher_id = e.id
        AND e.is_deleted = 0
        <where>
            c.is_deleted = 0

            <if test="name != null and name != ''">
                AND c.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="startDate != null and endDate != null">
                AND c.end_date BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
        ORDER BY c.update_time DESC, c.id DESC
    </select>

    <resultMap id="searchClazzResultMap"
               type="io.clementleetimfu.educationmanagementsystem.pojo.vo.clazz.ClazzSearchVO">
        <id property="id" column="id"/>
        <result property="clazzName" column="clazzName"/>
        <result property="teacherName" column="teacherName"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <insert id="insertClazz">
        INSERT INTO clazz (name, start_date, end_date, teacher_id, subject, create_time, update_time, is_deleted)
        VALUES (#{name}, #{startDate}, #{endDate}, #{teacherId}, #{subject}, #{createTime}, #{updateTime}, #{isDeleted})
    </insert>

    <select id="selectClazzById" resultMap="selectClazzByIdResultMap">
        SELECT id,
        name,
        start_date,
        end_date,
        teacher_id,
        subject
        FROM clazz AS c
        WHERE is_deleted = 0
        AND id = #{id}
        FOR UPDATE
    </select>

    <resultMap id="selectClazzByIdResultMap"
               type="io.clementleetimfu.educationmanagementsystem.pojo.vo.clazz.ClazzFindByIdVO">
        <result property="name" column="name"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="subject" column="subject"/>
    </resultMap>

    <update id="updateClazz">
        UPDATE clazz
        <set>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="startDate != null">
                start_date = #{startDate},
            </if>
            <if test="endDate != null">
                end_date = #{endDate},
            </if>
            <if test="teacherId != null">
                teacher_id = #{teacherId},
            </if>
            <if test="subject != null">
                subject = #{subject},
            </if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id}
        AND is_deleted = 0
    </update>

    <update id="deleteClazzById">
        UPDATE clazz
        SET
        is_deleted = 1,
        update_time = NOW()
        WHERE
        id = #{id}
        AND is_deleted = 0
    </update>

    <select id="selectAllClazz"
            resultType="io.clementleetimfu.educationmanagementsystem.pojo.vo.clazz.ClazzFindAllVO">
        SELECT
        id,
        name
        FROM clazz
        WHERE is_deleted = 0
        ORDER BY name;
    </select>

</mapper>